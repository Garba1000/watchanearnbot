<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>Watch & Earn</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://sad.adsgram.ai/js/sad.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    margin: 0;
    padding: 0;
    text-align: center;
    overflow-x: hidden;
  }

  #mainContainer {
    display: none;
    padding: 20px;
    margin-top: 30px;
    position: relative;
    z-index: 1;
  }

  .button {
    display: block;
    width: 220px;
    margin: 10px auto;
    padding: 12px 20px;
    background: #007bff;
    color: white;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    cursor: pointer;
  }

  #joinPopup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 999999999;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 25px;
  }

  #popupBox {
    background: #ffffff10;
    padding: 30px 20px;
    border-radius: 14px;
    width: 85%;
    max-width: 380px;
    text-align: center;
    backdrop-filter: blur(7px);
    border: 1px solid rgba(255,255,255,0.15);
  }

  #popupBox h2 {
    color: white;
    font-size: 22px;
    margin-bottom: 25px;
    line-height: 1.4;
  }

  #popupButton {
    display: block;
    width: 100%;
    padding: 14px;
    background: #ff3b30;
    color: white;
    font-size: 18px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: bold;
  }

  #taskMessage {
    display:none;
    color: #00ff00;
    font-weight:bold;
    margin-top: 10px;
  }
</style>
</head>

<body>

<!-- JOIN CHANNEL POPUP -->
<div id="joinPopup">
  <div id="popupBox">
    <h2>ğŸš« You must join our channel to continue</h2>
    <a id="popupButton"
       href="https://t.me/Konnetearnchannel"
       target="_blank"
       onclick="joinChannelClicked()">
       ğŸ‘‰ Join Telegram Channel
    </a>
  </div>
</div>

<!-- MAIN CONTENT -->
<div id="mainContainer">
  <h1>ğŸ¥ Watch & Earn</h1>
  <p>ğŸ’° Balance: $<span id="balance">0.00</span></p>
  <p>ğŸ‘¥ Referrals: <span id="referrals">0</span></p>
  <p style="color:#888;font-size:14px;">âš ï¸ You earn reward only after the person you invited completes launch the bot.</p>

  <button class="button" id="referralBtn">ğŸ”— Copy Referral Link</button>
  <button class="button" id="watchBtn">ğŸ¥ Watch Videos</button>
  <button class="button" id="taskBtn">âœ… Task</button>
  <button class="button" id="leadershipBtn">ğŸ† Leadership</button>
  <button class="button" id="withdrawBtn">ğŸ’µ Withdraw</button>

  <div id="taskSection" style="display:none;">
    <h3>Complete Task</h3>
    <adsgram-task id="currentTask" data-block-id="task-22205"></adsgram-task>
    <div id="taskMessage">ğŸ‰ Social task completed successfully!</div>
  </div>

  <div id="leadershipSection" style="display:none; margin-top:20px;">
    <h3>ğŸ† Leadership Board</h3>
    <ul id="leaderboardList"></ul>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

/* STORAGE KEYS */
const balanceKey = 'user_balance';
const joinKey = 'joined_channel';
const tasksKey = 'tasks_completed';
const referralsKey = 'referrals_data';
const leadershipRewardsKey = 'leadership_rewards';

/* ADMIN */
const ADMIN_ID = 6910486529;

/* INITIAL VALUES */
let balance = parseFloat(localStorage.getItem(balanceKey)) || 0.06;
let tasksCompleted = JSON.parse(localStorage.getItem(tasksKey)) || {};
let referralsData = JSON.parse(localStorage.getItem(referralsKey)) || {};

/* TASKS */
const taskQueue = ["task-21541", "task-21543", "task-21544", "task-22205"];
let taskIndex = 0;

/* REFERRAL TRACKING: Add new user to referrer immediately */
const urlParams = new URLSearchParams(window.location.search);
const referrerId = urlParams.get('start');
if(referrerId){
  if(!referralsData[referrerId]) referralsData[referrerId] = [];
  if(!referralsData[referrerId].includes(tg.initDataUnsafe.user.id)){
    referralsData[referrerId].push(tg.initDataUnsafe.user.id); // unverified
    localStorage.setItem(referralsKey, JSON.stringify(referralsData));
  }
}

/* UPDATE UI */
function updateUI() {
  document.getElementById("balance").textContent = balance.toFixed(2);
  // count all referrals (verified + unverified)
  let totalRefs = 0;
  for(let key in referralsData) totalRefs += referralsData[key].length;
  document.getElementById("referrals").textContent = totalRefs;
}
updateUI();

/* REFERRAL BUTTON */
document.getElementById("referralBtn").addEventListener("click", () => {
  const link = `https://t.me/Watchvideosebot?start=${tg.initDataUnsafe.user.id}`;
  navigator.clipboard.writeText(link);
  alert("Referral link copied!");
});

/* ADSGRAM INIT */
const RewardAd = window.Adsgram.init({ blockId: "21542" });

function addReward(amount) {
  balance += amount;
  localStorage.setItem(balanceKey, balance.toFixed(2));
  updateUI();
}

/* SHOW POPUP OR MAIN */
RewardAd.show().finally(() => {
  if(!localStorage.getItem(joinKey)){
    document.getElementById("joinPopup").style.display = "flex";
  } else {
    document.getElementById("mainContainer").style.display = "block";
  }
});

/* JOIN CHANNEL */
function joinChannelClicked(){
  if(!localStorage.getItem(joinKey)){
    addReward(0.001);
    localStorage.setItem(joinKey,"yes");
    updateUI();
    alert("ğŸ‰ +$0.001 rewarded!");
  }
  document.getElementById("joinPopup").style.display = "none";
  document.getElementById("mainContainer").style.display = "block";
}

/* WATCH VIDEO */
document.getElementById("watchBtn").addEventListener("click",()=>{
  RewardAd.show().then(res=>{ if(res.done) addReward(0.02); });
});

/* TASK BUTTON */
document.getElementById("taskBtn").addEventListener("click",()=>{
  document.getElementById("taskSection").style.display="block";
  loadTask(taskQueue[taskIndex]);
});

/* LOAD TASK */
function loadTask(id){
  const newTask = document.createElement("adsgram-task");
  newTask.setAttribute("data-block-id",id);
  newTask.id="currentTask";
  document.getElementById("currentTask").replaceWith(newTask);

  newTask.addEventListener("reward",()=>{
    addReward(0.02);

    tasksCompleted[id]=true;
    localStorage.setItem(tasksKey, JSON.stringify(tasksCompleted));

    if(taskIndex < taskQueue.length-1){
      taskIndex++;
    } else {
      taskIndex=0; // rotate again
      const msg = document.getElementById("taskMessage");
      msg.style.display="block";
      setTimeout(()=>{msg.style.display="none";},30000);
      checkReferralReward();
    }
    loadTask(taskQueue[taskIndex]);
  });
}

/* CHECK REFERRAL REWARD */
function checkReferralReward(){
  if(!referrerId) return;
  // Only reward if user completed all 4 tasks
  if(Object.keys(tasksCompleted).length >= taskQueue.length){
    addReferralReward(referrerId,tg.initDataUnsafe.user.id);
  }
  updateUI();
}

/* ADD REFERRAL REWARD */
function addReferralReward(referrer,userId){
  // Referrer earns $0.01 only after referral completes launch the bot
  addRewardForReferrer(referrer);
}

function addRewardForReferrer(referrerId){
  if(tg.initDataUnsafe.user.id == referrerId) return; // don't self-reward
  addReward(0.01);
  alert("ğŸ’° You earned $0.01 from your referral!");
  renderLeaderboard();
}

/* WITHDRAW */
document.getElementById("withdrawBtn").addEventListener("click",()=>{
  if(balance<5) return alert("âŒ Minimum withdraw is $5");
  tg.sendData(JSON.stringify({
    action:"forward_to_admin",
    admin_id:ADMIN_ID,
    user_id:tg.initDataUnsafe.user.id,
    amount:balance
  }));
  alert("âœ… Your withdrawal request has been forwarded to the admin.");
  balance=0;
  localStorage.setItem(balanceKey,balance.toFixed(2));
  updateUI();
});

/* LEADERSHIP BUTTON */
document.getElementById("leadershipBtn").addEventListener("click",()=>{
  document.getElementById("leadershipSection").style.display="block";
  renderLeaderboard();
});

/* RENDER LEADERBOARD */
function renderLeaderboard(){
  const list=document.getElementById("leaderboardList");
  list.innerHTML='';
  const rewardsDate=new Date("2026-03-14T00:00:00");
  const now=new Date();
  const leaderboard=[];
  for(let ref in referralsData){
    const verifiedCount = referralsData[ref].filter(uid => { return true; }).length;
    leaderboard.push({ref,count:verifiedCount});
  }
  leaderboard.sort((a,b)=>b.count-a.count);
  leaderboard.forEach((entry,idx)=>{
    const li=document.createElement('li');
    li.textContent=`#${idx+1} User: ${entry.ref} Referrals: ${entry.count}`;
    list.appendChild(li);

    if(now>=rewardsDate){
      let reward=0;
      if(idx===0) reward=60;
      else if(idx===1) reward=15;
      else if(idx===2) reward=10;
      else if(idx===3) reward=5;
      else if(idx===4) reward=3;
      else if(idx>=5 && idx<10) reward=1;
      if(reward>0 && !JSON.parse(localStorage.getItem(leadershipRewardsKey)||'[]').includes(entry.ref)){
        addRewardToUser(entry.ref,reward);
      }
    }
  });
}

/* CREDIT LEADERSHIP REWARD */
function addRewardToUser(userId,amount){
  if(tg.initDataUnsafe.user.id==userId){
    addReward(amount);
    alert(`ğŸ† Leadership reward $${amount} added to your balance!`);
  }
  let paidUsers=JSON.parse(localStorage.getItem(leadershipRewardsKey)||'[]');
  if(!paidUsers.includes(userId)){
    paidUsers.push(userId);
    localStorage.setItem(leadershipRewardsKey,JSON.stringify(paidUsers));
  }
}
</script>
</body>
</html>
