<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <title>Watch & Earn</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      text-align: center;
      overflow-x: hidden;
    }

    /* MAIN PAGE â€” HIDDEN FIRST */
    #mainContainer {
      display: none;
      padding: 20px;
      margin-top: 30px;
      position: relative;
      z-index: 1;
    }

    .button {
      display: block;
      width: 220px;
      margin: 10px auto;
      padding: 12px 20px;
      background: #007bff;
      color: white;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    /* TRUE POPUP (LIKE RADIOCASH) */
    #joinPopup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 999999999; /* ALWAYS ON TOP */
      display: none;
      justify-content: center;
      align-items: center;
      padding: 25px;
    }

    /* MODAL BOX */
    #popupBox {
      background: #ffffff10;
      padding: 30px 20px;
      border-radius: 14px;
      width: 85%;
      max-width: 380px;
      text-align: center;
      backdrop-filter: blur(7px);
      border: 1px solid rgba(255,255,255,0.15);
    }

    #popupBox h2 {
      color: white;
      font-size: 22px;
      margin-bottom: 25px;
      line-height: 1.4;
    }

    #popupButton {
      display: block;
      width: 100%;
      padding: 14px;
      background: #ff3b30;
      color: white;
      font-size: 18px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>

<body>

<!-- RADIOCASH STYLE POPUP -->
<div id="joinPopup">
  <div id="popupBox">
    <h2>ðŸš« You must join our channel to continue</h2>
    <a id="popupButton"
       href="https://t.me/Konnetearnchannel"
       target="_blank"
       onclick="joinChannelClicked()">
       ðŸ‘‰ Join Telegram Channel
    </a>
  </div>
</div>

<!-- MAIN CONTENT -->
<div id="mainContainer">
  <h1>ðŸŽ¥ Watch & Earn</h1>
  <p>ðŸ’° Balance: $<span id="balance">0.00</span></p>
  <p>ðŸ‘¥ Referrals: <span id="referrals">0</span></p>

  <button class="button" id="referralBtn">ðŸ”— Copy Referral Link</button>
  <button class="button" id="watchBtn">ðŸŽ¥ Watch Videos</button>
  <button class="button" id="taskBtn">âœ… Task</button>
  <button class="button" id="withdrawBtn">ðŸ’µ Withdraw</button>

  <div id="taskSection" style="display:none;">
    <h3>Complete Task</h3>
    <adsgram-task id="currentTask" data-block-id="task-17635"></adsgram-task>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

/* STORAGE KEYS */
const balanceKey = 'user_balance';
const refsKey = 'user_refs';
const joinKey = 'joined_channel';

/* INITIAL VALUES */
let balance = parseFloat(localStorage.getItem(balanceKey)) || 0.06;
let referrals = parseInt(localStorage.getItem(refsKey)) || 0;

function updateUI() {
  document.getElementById("balance").textContent = balance.toFixed(3);
  document.getElementById("referrals").textContent = referrals;
}
updateUI();

/* REFERRAL BUTTON */
document.getElementById("referralBtn").addEventListener("click", () => {
  const link = `https://t.me/Watchvideosebot?start=${tg.initDataUnsafe.user.id}`;
  navigator.clipboard.writeText(link);
  alert("Referral link copied!");
});

/* ADSGRAM */
const RewardAd = window.Adsgram.init({ blockId: "21542" });

function addReward(amount) {
  balance += amount;
  localStorage.setItem(balanceKey, balance.toFixed(3));
  updateUI();
}

/* PRELOAD AD FIRST THEN SHOW POPUP */
RewardAd.show().finally(() => {
  if (!localStorage.getItem(joinKey)) {
    document.getElementById("joinPopup").style.display = "flex";
  } else {
    document.getElementById("mainContainer").style.display = "block";
  }
});

/* JOIN CHANNEL CLICK */
function joinChannelClicked() {
  if (!localStorage.getItem(joinKey)) {
    balance += 0.001; /* YOUR REWARD */
    localStorage.setItem(balanceKey, balance.toFixed(3));
    localStorage.setItem(joinKey, "yes");
    updateUI();
    alert("ðŸŽ‰ +$0.001 rewarded!");
  }

  /* REMOVE POPUP WITHOUT REFRESH */
  document.getElementById("joinPopup").style.display = "none";
  document.getElementById("mainContainer").style.display = "block";
}

/* WATCH VIDEO */
document.getElementById("watchBtn").addEventListener("click", () => {
  RewardAd.show().then(res => {
    if (res.done) addReward(0.02);
  });
});

/* TASK SYSTEM */
const taskQueue = ["task-17636", "task-17637", "task-17635"];
let taskIndex = 0;

document.getElementById("taskBtn").addEventListener("click", () => {
  document.getElementById("taskSection").style.display = "block";
  loadTask(taskQueue[taskIndex]);
});

function loadTask(id) {
  const newTask = document.createElement("adsgram-task");
  newTask.setAttribute("data-block-id", id);
  newTask.id = "currentTask";

  document.getElementById("currentTask").replaceWith(newTask);

  newTask.addEventListener("reward", () => {
    addReward(0.02);

    if (taskIndex < taskQueue.length - 1) taskIndex++;
    else {
      taskIndex = 0;
      addReward(0.06);
    }

    loadTask(taskQueue[taskIndex]);
  });
}

/* WITHDRAW */
document.getElementById("withdrawBtn").addEventListener("click", () => {
  if (balance < 5) return alert("âŒ Minimum withdraw is $5");

  tg.sendData(JSON.stringify({ action: "withdraw", amount: balance }));
  alert("Withdraw request sent.");
  balance = 0;
  localStorage.setItem(balanceKey, balance.toFixed(3));
  updateUI();
});
</script>

</body>
</html>
